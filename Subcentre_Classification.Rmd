---
title: "Exploring Typologies of Employment Subcentres in London, England"
author: Jacob L. Macdonald, University of Liverpool; Jacob.Macdonald@liverpool.ac.uk & Pranjal Dave
output: rmarkdown::github_document
always_allow_html: true
knit: (function(inputFile, encoding) { rmarkdown::render(inputFile, encoding = encoding, output_file = paste0(dirname(inputFile),'/README.md')) })
---



```{r Project Setup, include=F}
# ---
# title: "Exploring Typologies of Employment Subcentres in London, England"
# author:
# - Jacob L. Macdonald, University of Liverpool; Jacob.Macdonald@liverpool.ac.uk
# - Pranjal Dave
# output: rmarkdown::github_document
# always_allow_html: true
# knit: (function(inputFile, encoding) { rmarkdown::render(inputFile, encoding = encoding, output_file = paste0(dirname(inputFile),'/README.md')) })
# ---

library(data.table)
library(sf)
library(tidyverse)
library(grid)
library(gridExtra)
library(knitr)
library(tidytext)
# library(randomcoloR)
# library(ggpubr)
# library(ggplot2)
# library(dplyr)
# library(tidygraph)
# library(numDeriv)
# library(stringr)
# library(rgeos)
# library(maptools)

knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(warning = FALSE)

wd <- paste0(ifelse(Sys.info()[[1]]=="Linux", paste0("/home/", Sys.info()[[7]], "/Documents"), paste0("/Users/", Sys.info()[[7]])), "/Dropbox/Research/Employment/Business & Employment")
wd.data <- paste0(wd, "/Data")
```

## 1. Introduction

This *.Rmd* document explores an industry-based breakdown of business and employment densities within London's urban employment subcentres. A monocentric urban detection algorithm is first applied to identify the spatial extent of dense employment hot-spots in the peripheral areas surrounding the primary central business district (CBD) (available through x___x). The sectoral composition of different employment subcentres in the city are tracked using spatially granular employment and business registry details according to broad industry typologies. We make a particular distinction between those subcentres and employment cores making up London's well defined Central Activity Zone (CAZ) - a central employment region itself on an international scale, orders of magnitude above other employment centres and subcentres across the country.

Employment subcentres are characterized by the spatial clustering of areas outside the traditional CBD with locally higher employment densities. The location of these employment hotspots within an urban area, and their broader use, typology and function, are important to consider in municipal planning as these zones oftentimes dualy serve as inter-city hubs for transportation, commercial or business networks and can have wide spill over influences to other urban markets such as residential or commercial real estate.

We identify employment subcentres in London as local clusters of census tracts deviating from the monocentric city model of centralized employment density. Employment and business density in London gravitate towards its geographic and historic centre, and employment subcentres are delineated here via a threshold cutoff model based on exponential density decay. This algorithmic application of the *Method of Exponentially Decaying Cutoffs* stems from Ban et al. (2017) and Macdonald (forthcoming x___x), updating the flexibility of functional form decay and tailoring towards the London context.

After delineating the location of these employment hotspots within the urban area, this work explores the typological breakdown of different industry measures within these geographic employment subcentre zones. The identification of employment zones across an urban area are often conditional on total employment density. It is thus also important to consider how different employment subcentres may vary in terms of their broad function and relationship to the local environment, since different centres and hubs within a municipality may serve very different purposes depending on which industries are most prominent. This is particularly the case in London where employment and industry sectors are known to be heavily tied to geography.

Using spatially granular employment and business statistics at the (SIC 2007) industry level helps to bridge the gap in detailing the heterogeneity of different types of workzone hubs. One of the major caveats, however, is the temporal limitation which often comes at the expense and in tradeoff to spatial and geographic detail. In the case of small-area employment statistics, which are a fundamental parameter of many theoretical urban models, spatially detailed and comparable employment levels are often only available with every census release. We use the most recent, open and comprehensive granular small area employment levels at the Workplace Zone (WZ) geographic scale from the 2011 Census. Given the particular emphasis on delineating spatial extents in high density employment zones, WZ boundaries are more appropriate than traditional LSOA levels.

While employment density statistics may be limited in temporal scope, other datasets like business registries, for example, may be able to supplement and serve as a proxy to identify patterns of economic density and spatial clustering. The [CDRC Business Census](https://data.cdrc.ac.uk/dataset/business-census) datasets provide yearly snapshots of registered businesses and industry typologies across England with granular location information. This allows us to extend beyond the limitations of only having detailed (openly accessible) employment detail at small area scales available from 2011 by comparing the granular spatial patterns of employment and business density and tracking the subsequent evolution of business and sector dynamics. 

Employment subcentres, and their location, are inherently complex and linked to any number of urban dynamics from population densities, transportation links, urban or natural amenities. Using the distribution of registered businesses by industry sector located within subcentres can identify commonalities and differences between these key urban locations. The spatial distribution of a city's workforce can have important implications on any number of urban policies. Even more, as different sectors and industries of the economy can have varying workforces and geographic patterns, open source spatial and granular tools and data to explore these dynamics can be just one way to explore and highlight these dynamics for informed research-based decision making.


## 2. Data and Study Region

### 2.1. Granular Employment and Business Data

This work is conducted using entirely open and accessible data and tools. The most recent geographically granular available data on employment levels is from the UK Census 2011, obtained online through the [Nomis](https://www.nomisweb.co.uk/ "ONS Nomis Labour Market Statistics") platform. Detailed working day population statistics are available for small area Workplace Zone (WZ) tract boundaries allowing spatial measures of employment density to be constructed. We are specifically interested in the employment levels (Table WP102EW), along with corresponding industry sector breakdown, as they are distributed across space.

While no choice of spatial unit to use for research and statistical purposes can be uniquely accurate, WZ boundaries provide the most granular detail in key employment zones such as the main CBD of London. The WZ boundaries are geographically delineated to align better with patterns of the employed workday population as opposed to the resident population. While other census geographic areas, such as Output Areas, are constructed around consistent populations within each spatial unit, WZ boundaries are constructed around consistent workers in each unit (ONS 2014). With this in mind, the WZ areas are significantly more detailed in city centre areas where employment levels and densities are largest.

Employment subcentres in a given region are delineated based only on total employment, local densities, and distances to some central, densest, location. Clusters of high density total employment areas are organized into contiguous tracts representing geographic workplace hubs across the city. This total employment distribution however can mask significant heterogeneity in the types and functions of different workforces and geographic locations. While an employment subcentre more tailored to financial services workforces may attract only the local working population, retail or service based subcentres may draw in residents and people from the urban peripherals. 

Additional data at the WZ level are further included to help characterize the different typologies and varying characteristics of these different areas. Employment data for each industry grouping is obtained from Census Table WP605EW coded according to the [UK Standard Industrial Classification (SIC) Hierarchy](https://onsdigital.github.io/dp-classification-tools/standard-industrial-classification/ONS_SIC_hierarchy_view.html). Broad Industry Groups (BIG) of SIC codes are used to define the highest level of sector aggregation. We also make use of the two-digit SIC Division for more detailed tracking of the specific industry sectors which are associated to London as a whole and namely to the CBD and subcentre areas of the city towards where employment gravitates.

```{r WZ Employment Data Import, include=F}
London <- fread(paste0(wd.data, "/Local_Authority_District_to_Region__December_2020__Lookup_in_England.csv"))
London <- London[London$RGN20NM=="London",]
London <- unique(London$LAD20CD)

## Read in WZ boundary, subset to London only (N = 8,154)
WZ.db <- st_transform(st_read(paste0(gsub("/Business & Employment", "/Employment Subcentres/Data", wd), "/Workplace_Zones_December_2011_Generalised_Clipped_Boundaries_in_England_and_Wales.shp"), 
  stringsAsFactors = F, quiet = T), crs=27700)[,c("wz11cd", "lad11cd", "lad11nm")]
WZ.db <- WZ.db[WZ.db$lad11cd %in% London,]
WZ.db$area_ha <- as.numeric(st_area(WZ.db))*0.0001

## Merge in total WZ employment (Census 2011 Table WP102EW)
t <- fread(paste0(wd.data, "/WP102EW.csv"))
WZ.db <- merge(WZ.db, t, all.x=T, sort=F, by.x="wz11cd", by.y="WZ_CD"); rm(t)

## Merge in WZ employment by SIC industry (Census 2011 Table WP605EW)
t <- fread(paste0(wd.data, "/Census_WZ_2011.csv"))[,-c("Emp_2011")]
WZ.db <- merge(WZ.db, t, all.x=T, sort=F, by.x="wz11cd", by.y="WZ_CD"); rm(t)

## Merge in London WZ Classification
t <- fread(paste0(wd.data, "/LWZC Classification.csv"))
WZ.db <- merge(WZ.db, t[,c("WZ_CD", "Group", "SubGroup")], all.x=T, sort=F, by.x="wz11cd", by.y="WZ_CD"); rm(t)

names(WZ.db)[names(WZ.db)=="wz11cd"] <- "WZ_CD"
names(WZ.db)[names(WZ.db)=="lad11cd"] <- "LAD_CD"
names(WZ.db)[names(WZ.db)=="lad11nm"] <- "LAD_NM"
names(WZ.db)[names(WZ.db)=="Emp_2011"] <- "employment"
WZ.db$density <- ifelse(is.na(WZ.db$employment/WZ.db$area), 0, WZ.db$employment/WZ.db$area)
WZ.db <- unique(WZ.db)

## This final code piece is a bit of spatial cleaning in order to go from
##   a MULTIPOLYGON object with holes to a cleaned POLYGON OBJECT
t <- st_cast(WZ.db, "POLYGON")
t1 <- t[t$WZ_CD %in% t[which(duplicated(t$WZ_CD)),]$WZ_CD,]
t <- t[!(t$WZ_CD %in% t1$WZ_CD),]
t1$area <- as.numeric(st_area(t1))*0.0001
t2 <- t1 %>% 
  group_by(WZ_CD) %>%
  filter(area == max(area)) %>%
  arrange(WZ_CD) %>%
  select(-c(area))
t2 <- st_sf(data.frame(t2))
WZ.db <- rbind(t, t2)
rm(t, t1, t2)
```

To complement employment levels, and better understand the built and physical surroundings of these employment areas, we merge in data on registered businesses from the [Consumer Data Research Centre (CDRC) Business Census](https://data.cdrc.ac.uk/dataset/business-census) data from Companies House. While granular employment data is limited in terms of temporal frequency, more detailed and up to date open data is available for business registries. Understanding the link between employment subcentres and the types of businesses making them up can thus be used to explore higher frequency changes to these areas than what traditionally limited employment data can provide.

Registered businesses for London are provided along with SIC industry classification code and post code location identifier. A series of cleaning is done to the data to retain only active (and non-dormant) companies with a valid post code and SIC classification. Complete data is available in yearly snapshots from 2013 to 2019. Using the National Statistics Postal Lookup 2020 we obtain a proxy latitude and longitude from the postcode and run a spatial join to get a count of businesses of different industries for each WZ location. We use the first two-digits of the SIC code representing industry Divisions in the hierarchical scheme (nested within Sections and BIG groupings) allowing us to get a distribution of counts for different types of businesses in each area.

```{r Business Data Geocoding; Cleaning; WZ Aggregation, include=F}
# ## Import and sequentially merge to yearly business datasets for geocoding
# nspl.lookup <- fread(paste0(wd.data, "/NSPL_NOV_2020_UK.csv"), header=T, na.strings=c("", "NA", "-", "- -", ".", ",")) %>%
#   as_tibble() %>%
#   filter(laua %in% WZ.db[WZ.db$Region=="London",]$LAD_CD) %>%
#   select(pcd, lat, long, lsoa11, wz11) %>%
#   mutate(pcd_merge=gsub("[[:space:]]", "", pcd)) %>%
#   select(-c("pcd")) %>%
#   unique()
# 
# ## Replace out the year (2013 - 2019) and save the clean filtered file
# business.census <- fread(paste0(wd, "/Data/business_census2019.csv")) %>%
#   as_tibble() %>%
#   select(companynumber, dissolutiondate, incorporationdate, addressline1, addressline2, posttown, county, country, postcode, companycategory, companyname, companystatus, siccode) %>%
#   mutate(pcd_merge=gsub("[[:space:]]", "", postcode)) %>%
#   left_join(nspl.lookup, by="pcd_merge") %>%
#   filter(!is.na(lsoa11) | !is.na(wz11))
# fwrite(business.census, paste0(wd, "/Data/BC_2019.csv"))
# 
# ## Read in all the cleaned business data years:
# ##   - Remove dormant companies (SIC == 99999)
# ##   - Keep active companies with post code and SIC code
# BC.data <- lapply(as.list(c("2013","2014","2015","2016","2017","2018","2019")), function(x){
#   test <- fread(paste0(gsub("Business & Employment/Data", "Data", wd.data), "/BC_", x, ".csv")) %>%
#     mutate(siccode=ifelse(nchar(siccode) < 5, paste0("0", siccode), paste0(siccode))) %>%
#     filter(siccode!=99999 & companystatus=="Active" & !is.na(postcode)) %>%
#     mutate(SIC=substr(as.character(siccode), 1, 2)) %>%
#     group_by(wz11, SIC) %>%
#     count() %>%
#     spread(SIC, n) %>%
#     replace(is.na(.), 0)
#   names(test) <- c("wz11", paste0("SIC_", names(test)[-1]))
#   test$Total <- rowSums(test[,-1])
#   test$Year <- x
#   return(test)
# })
# saveRDS(BC.data, file=paste0(wd, "/Data/Business_Counts.rds"))
# 
# ## A pre-cleaned final file can be read in to skip the above
# ##   - List file for different years with a cleaned WZ database of SIC Business counts
# ##   - Keep only the years 2013 - 2019 where complete data is available
BC.data <- readRDS(file=paste0(wd.data, "/Business_Counts.rds"))
```

Granular business data is more easily available consistently over space and time compared to spatially detailed employment data. Other sources of workday employment levels may be available at more frequent temporal updates including, for example, small area estimates from the [Business Registry and Employment Survey](https://www.ons.gov.uk/surveys/informationforbusinesses/businesssurveys/businessregisterandemploymentsurvey). These estimates however are only openly available at the Lower Super Output Area (LSOA) level which have relatively large units in areas where employment density is highest - by design. As LSOA boundaries are delineated with the idea of consistent populations, high density employment areas will necessarily have less refined spatial units to match benchmark resident population.

Finally, the  CDRC [London Workplace Zone Classification (LWZC)](https://data.cdrc.ac.uk/dataset/london-workplace-zone-classification) is a geogdemographic at the WZ level providing a clustering classification for each geography based on a series of input data, and tailored to London specific. This classification identifies different types of WZ compositions across six domains including the areas employment structure, dynamism, employee characteristics, job characteristics, commuting, and residential context. Each WZ is assigned to one of six supergroups classifying areas into residential, city focus, or metropolitan among other finer disaggregations. All together, this gives us a view of each individual WZ tract in terms of its sector-based employment, density, and characteristics of the local demographics. As WZ are self-organized into employment subcentre clusters, we will be able to compare the composition and evolution of these geographic areas relative to the remainder of the city.


### 2.2. Study Region: London, England

The focus of this work is London, England. As capital and international city, London attracts a sizeable workforce and population with around 6 million jobs in 2019 and steadily increasing over the long run (ONS 2020). Much of this workforce come from outside of the UK either from the EU or elsewhere in the world (PwC 2017) attracted by jobs in professional services, scientific and technical industries, finance and insurance, information and communication, and business administration and support services.

London has a total of 8,154 WZ tracts spread over a total area of 157,353 hectares (1,573.5 km$^2$). The map of WZ employment density deciles reveal a clear central clustering pattern, however several periphiral employment hotspots are visible as well. From an aerial perspective, London follows clear patterns of monocentricity centered around the city's geographic and historic centre. Total employment densities are highest primarily in the central area along the Thames river, with a decaying pattern of declining densities moving in any direction towards the city peripheral.

```{r London Map of Employment Density, echo=F, fig.asp = 0.8, fig.width = 7, out.width = "100%"}
WZ.db$density.DEC <- cut(WZ.db$density, breaks = quantile(WZ.db$density, probs = 0:10/10, na.rm=T), labels = 1:10, right=F, include.lowest=T)

ggplot() +
  geom_sf(data = WZ.db, aes(fill = density.DEC), lwd = 0) +
  scale_fill_manual(values=colorRampPalette(c("#E8F4F2", "#106355"))(10), na.translate=FALSE) +
  labs(title = "London Employment Density", subtitle = "Jobs per ha. deciles",
       caption = "Source: ONS - Census 2011") +
  scale_x_continuous(expand = c(0,0)) +
  coord_sf() +
  guides(shape = guide_legend(override.aes = list(size = 1)), fill = guide_legend(override.aes = list(size = 1)),
    color = guide_legend(override.aes = list(size = 1))) +
  theme_classic() +
  theme(axis.title.x=element_blank(), axis.text.x=element_blank(), axis.ticks.x=element_blank(), 
    axis.title.y=element_blank(), axis.text.y=element_blank(), axis.ticks.y=element_blank(), 
    legend.title = element_blank(), panel.background=element_rect(fill="#E5E5E3"), plot.caption = element_text(face = "italic"))
```

This general indication of monocentricity in employment density is important to verify prior to the application of a subcentre identification model built on density gradient decay. While many cities follow patterns of clustered employment density towards the geographic centre of the city, a first stage mapping of current employment densities is important.

The central point of London which serves as the main employment hub is known as the Central Activities Zone (CAZ), a well delineated geographic area serving as the anchor for London's economy and competitive location for businesses and industries. This CAZ encompasses the heart of London, the UK and even international financial industries, cultural amenities, entertainment, shopping and tourism. As a relatively small geographic zone, this particular employment centre is responsible for around 10% of all UK output (City of London XXXX).

The definition of the main CBD, from which monocentric distances are calculated, is key for the identification of employment subcentres with the exponentially decaying method. While there is much discussion on defining a potentially unique CBD point within urban areas, we choose the CBD to be the WZ with the highest employment density. In the sample for London this corrsponds to the area covering Plantation Place in the City of London, one of the largest office development areas and the primary financial district of London. While choosing the densest employment tract may not necessarily correspond to a city's central business district location, in the case of London this location is well centrally placed. The CBD is found to be in the main hub of the CAZ and located almost directly halfway between Charing Cross - the conventional "Centre of London", and Canary Wharf - London's well known secondary CBD housing much of the country's financial sector.

```{r Central London & CBD, echo=F, fig.asp = 0.8, fig.width = 7, out.width = "100%"}
CAZ <- st_transform(st_read(paste0(wd.data, "/lp-consultation-oct-2009-central-activities-zone.shp"), 
  stringsAsFactors = F, quiet = T), crs=27700)

data.frame(WZ.db[which.max(WZ.db$density),])[,c("WZ_CD", "LAD_CD", "LAD_NM", "area_ha", "employment", "density")]

WZ.db$dist.CBD <- as.numeric(st_distance(st_transform(st_as_sf(st_centroid(st_geometry(WZ.db))), crs=4326), 
  st_transform(st_as_sf(st_centroid(st_geometry(WZ.db[which.max(WZ.db$density),]))), crs=4326), which ="Great Circle"))*0.001

## Manually using the latitude and longitude of Charing Cross to calculate distances
CC <- st_transform(st_as_sf(data.frame(cbind(lat=c(51.508291), long=c(-0.127941))), coords = c("long", "lat"), crs = 4326), crs = 27700)
CBD2 <- st_transform(st_as_sf(data.frame(cbind(lat=c(51.50475), long=c(-0.020057))), coords = c("long", "lat"), crs = 4326), crs = 27700)
CBD <- st_centroid(WZ.db[which.max(WZ.db$density),])

ggplot() +
  geom_sf(data = CAZ, colour="black", lwd=1, show.legend = FALSE) +
  geom_sf(data = WZ.db, aes(fill = density.DEC), lwd = 0, alpha=0.4, show.legend = FALSE) +
  geom_sf(data = st_buffer(CBD, 500), alpha=0, color=alpha("Black", 0.6), show.legend = FALSE, lwd = 1) +
  geom_sf(data = CBD, color = "Black") +
  geom_sf(data = st_buffer(CC, 500), color=alpha("#817fc5", 0.7), show.legend = FALSE, lwd = 1, linetype="dashed", alpha=0) +
  geom_sf(data = CC, color = "#817fc5", alpha=0.7) +
  geom_sf(data = st_buffer(CBD2, 500), color=alpha("#817fc5", 0.7), show.legend = FALSE, lwd = 1, linetype="dashed", alpha=0) +
  geom_sf(data = CBD2, color = "#817fc5", alpha=0.7) +
  scale_fill_manual(values=colorRampPalette(c("#E8F4F2", "#106355"))(10), na.translate=FALSE) +
  labs(title = "London Central Activity Zone", subtitle = "City Centre and Central Business District", caption = "(Conventional centre 'Charing Cross' & Secondary Financial District 'Canary Wharf' highlighted)\nCBD (densest tract) 'Plantation Place'") +
  scale_x_continuous(expand = c(0,0)) +
  coord_sf(crs=27700, xlim=c(st_bbox(CAZ)[["xmin"]]*(1-.01), st_bbox(CAZ)[["xmax"]]*(1+.01)), 
    ylim=c(st_bbox(CAZ)[["ymin"]]*(1-.01), st_bbox(CAZ)[["ymax"]]*(1+.01))) +
  guides(shape = guide_legend(override.aes = list(size = 1)), fill = guide_legend(override.aes = list(size = 1)),
    color = guide_legend(override.aes = list(size = 1))) +
  theme_classic() +
  theme(axis.title.x=element_blank(), axis.text.x=element_blank(), axis.ticks.x=element_blank(), 
    axis.title.y=element_blank(), axis.text.y=element_blank(), axis.ticks.y=element_blank(), 
    legend.position="bottom", legend.title = element_blank(), panel.background=element_rect(fill="#E5E5E3"), plot.caption = element_text(face = "italic"))
rm(CC, CBD, CBD2)
```

Patterns of registered business density deciles follow very similar patterns as with employment level density. A central core area of very high business density towards the central area of the city decaying over space as we move into the city periphery. There are marginal changes to the spatial pattern of business density in London from 2013 to 2019, both highlighting the importance and stability of the geographic centre of the city for business and employment concentrations. 

```{r London Map of Business Density 2013, echo=F, fig.asp = 0.8, fig.width = 7, out.width = "100%"}
WZ.db <- merge(WZ.db, BC.data[[1]][,c("wz11", "Total")], all.x=T, sort=F, by.x="WZ_CD", by.y="wz11")
names(WZ.db)[names(WZ.db)=="Total"] <- "business_2013"
WZ.db <- merge(WZ.db, BC.data[[7]][,c("wz11", "Total")], all.x=T, sort=F, by.x="WZ_CD", by.y="wz11")
names(WZ.db)[names(WZ.db)=="Total"] <- "business_2019"
WZ.db$business_2013 <- cut(WZ.db$business_2013/WZ.db$area_ha, breaks = quantile(WZ.db$business_2013/WZ.db$area_ha, probs = 0:10/10, na.rm=T), labels = 1:10, right=F, include.lowest=T)
WZ.db$business_2019 <- cut(WZ.db$business_2019/WZ.db$area_ha, breaks = quantile(WZ.db$business_2019/WZ.db$area_ha, probs = 0:10/10, na.rm=T), labels = 1:10, right=F, include.lowest=T)

ggplot() +
  geom_sf(data = WZ.db, aes(fill = business_2013), lwd = 0) +
  scale_fill_manual(values=colorRampPalette(c("#F2F2F9", "#5A598A"))(10), na.translate=FALSE) +
  labs(title = "London Business Density", subtitle = "Business per ha. deciles 2013", x = "", y = "") +
  scale_x_continuous(expand = c(0,0)) +
  coord_sf(crs=27700, xlim=c(st_bbox(CAZ)[["xmin"]]*(1-.03), st_bbox(CAZ)[["xmax"]]*(1+.03)), 
    ylim=c(st_bbox(CAZ)[["ymin"]]*(1-.03), st_bbox(CAZ)[["ymax"]]*(1+.03))) +
  theme_classic() +
  theme(axis.text.x=element_blank(), axis.ticks.x=element_blank(), axis.text.y=element_blank(), axis.ticks.y=element_blank(), 
    legend.position="none", legend.title = element_blank(), panel.background=element_rect(fill="#E5E5E3"))
```

```{r London Map of Business Density 2019, echo=F, fig.asp = 0.8, fig.width = 7, out.width = "100%"}
ggplot() +
  geom_sf(data = WZ.db, aes(fill = business_2019), lwd = 0) +
  scale_fill_manual(values=colorRampPalette(c("#F2F2F9", "#5A598A"))(10), na.translate=FALSE) +
  labs(title = "", subtitle = "Business per ha. deciles 2019", x = "", y = "") +
  scale_x_continuous(expand = c(0,0)) +
  coord_sf(crs=27700, xlim=c(st_bbox(CAZ)[["xmin"]]*(1-.03), st_bbox(CAZ)[["xmax"]]*(1+.03)), 
    ylim=c(st_bbox(CAZ)[["ymin"]]*(1-.03), st_bbox(CAZ)[["ymax"]]*(1+.03))) +
  guides(shape = guide_legend(override.aes = list(size = 1)), fill = guide_legend(override.aes = list(size = 1)),
    color = guide_legend(override.aes = list(size = 1))) +
  theme_classic() +
  theme(axis.text.x=element_blank(), axis.ticks.x=element_blank(), axis.text.y=element_blank(), axis.ticks.y=element_blank(), 
    legend.position="bottom", legend.title = element_blank(), panel.background=element_rect(fill="#E5E5E3"))
```

Total employment in 2011 was 4,500,481 across 157,353 hectares. London is split into 32 boroughs alongside the central City of London. These 33 regions vary in terms of the size and distribution of employment levels, and the respective density of employment. Below we show the general distribution of employment across the WZ census tracts for each of the 33 boroughs in the Greater London Municipality, ranked by their average distance to the dense CBD of the city.

```{r London Borough Descriptive Statistics, echo=F}
LAs <- as_tibble(WZ.db) %>%
  dplyr::group_by(LAD_NM) %>%
  dplyr::summarize(tot.area=sum(area_ha), tot.employment=sum(employment), 
    avg.WZarea=mean(area_ha), avg.WZemployment=mean(employment), 
    max.WZdensity=max(density), avg.WZdensity=mean(density),
    avg.WZdistCBD=mean(dist.CBD))

knitr::kable(LAs[order(LAs$avg.WZdistCBD),][1:15,], digits = 2, 
  col.names = c("", "Area (ha)", "Employment", "Avg. Tract Size", "Avg. Tract Employment", "Max. Density", "Avg. Density", "Avg. Dist to CBD (km)"), 
  caption="Top 15 London Boroughs by Distance to CBD", align=c("lccccccc"))
```

This table shows the extent to which employment and employment density fall as we move further away from the central area of the city. Significant employment densities are found in the most central boroughs in London which correspond to those inner CAZ areas responsible for a large portion of the workforce, output and economic activity of the city and country as a whole including: City of London, Southwark, and Tower Hamlets. These aggregate borough level statistics however mask much more detailed spatial patterns. Building a series of employment centre and subcentre zones using granular open data allows us to identify these employment hotspots across the entire municipality.


## 3. Employment Subcentre Identification

The literature on subcentre identification is wide and employs a range of different methodologies. Primarily, subcentres can be identified using a functional form approach in comparing employment densities to expected values with appropriate decaying on distance from a central point; or highlight spatial clusters and similarities in employment dynamics based on local spatial autocorrelation parameters. The choice of method is dependant on the study context and underlying assumptions on the spatial structure of the urban area. In urban areas described well by some historic and geographic area (CBD) from which employment decays exponentially, we can use the estimated shape of this decay to identify outlier areas based on some threshold values.

The subcentre identification algorithm here is based off a parametric model of monocentric employment density (sources xxxxx). A more flexible functional form approach to the Giuliano and Small (1991) and Ban et al. (2017). The subcentre identification algorithm used is based on exponentially decaying cutoffs used to identify clusters of local tracts of employment which have densities and total employment levels exceeding the expected value of density from a purely monocentric decay model of employment density. 

### 3.1. Method of Exponentially Decaying Cutoffs

This method of exponential decay is adopted from Ban et al. (2017) and adopted for the London context.

The method of exponentially decaying cutoff is undertaken in two parts: firstly by identifying candidate tracts which have significant employment density, and secondly in grouping contiguous candidate tracts and identifying subcentres via total employment levels.

Underlying the identification is the concept of exponentialy decaying employment density from a monocentric CBD. Specifying this formulation, where $x$ represents distance to the CBD (such that at the CBD $x=0$), the expected employment density at any location periphiral to the CBD ($D_x$) can be estimated under the assumption of monocentric decay over space. Using the corresponding value of peak employment density at the CBD, $\underline{D}$, as we move further away from the core employment centre density can be expected to decay at an exponential rate along some density gradient defined by (some negative function) $f(x)$. 

$$D_x = \underline{D} \cdot e^{f(x)}$$

In this above specification $\underline{D}$ represents some basline value of employment density at the central location, with absolute density declining at an exponential rate. The $\log$ version represents the relative change, or the proportional rate at which density decays with respect to the CBD. 

$$\ln(D_x) = \ln(\underline{D}) + f(x)$$

The function, $f(x)$, represents the form of the assumed employment density gradient decline over space. In Ban et al. (2017), a linear form of $f(x) = - \alpha \cdot x$ was used to estimate the gradient.   assumption on the gradient (linear in the proportional decrease in density; exponential in the absolute) thus would dictate that the rate at which employment density changes is constant over space. This is the functional form assumed in the subcentre identification work for Los Angeles (Eq. page 10 Ban et al. (2017)).

$$f(x) = \alpha + \beta \cdot \ln(x)$$

In the case of London, employment density patterns across the city highlight clear strong central tendencies. The unique relative symmetry of the city further enforces this centrality. As such, identifying subcentre outliers from an exponential decay from this clearly centrally dense employment location will be able to identify global subcentres and candidate areas where employment positively deviates from this expectation. 

We update the Ban et al. (2017) method for London by allowing for a more flexible selection of input parameters accounting for core employment density, and further by choosing a more flexible functional form for the employment decay gradient.



The subcentre identification algorithm proceeds as follows:

1- 
2- 
3- Candidate tracts are elevated to subcentres if 


### 3.2. Parameter Fine-Tuning

Two key parameters on employment level and density are used in the exponentially decaying subcentre identification method by Giuliano and Small (1991) and subsequently adapted by Ban et al. (2017). These include the 

An updated computational algorithm to delineate urban employment subcentres is provided and applied in Macdonald (xxxxx). This open source tool reads in small area employment density statistics and applies the above model of exponentionally decaying cutoff thresholds to identify employment areas. The density of employment at each WZ tract is compared against the expected value from that which could be predicted from a monocentrically decaying model. Where contiguous tracts of peripheral WZ's meet the above criteria, relative to the central zone, exceed employment and density values, then it can be classified as an urban employment subcentre. 

The input paremeters are based on identifying the benchmark employment density from which we expect monocentric decay, the A parameter above, and the density of this central area. The updated algorithm in Macdonald (xxxx) allows for increased flexibility from Ban et al. (2017) and can thus be applied in a variety of different settings. Rather than input a direct value of starting employment and density, as is the case in the so-called "(20, 49)" model - which are essentially fine tuned exactly to the California 1980 context. Instead, we input a value of distance for both the employment and density respectively. The value, A, and density, D, needed for the model are taken as the respective sum and average value of total employment taken directly from the statistics in the area surrounding directly from the CBD point. 

Secondly, the updated algorithm allows for the choice of density decay gradient function to better match observed spatial patterns. We can thus explore and evaluate the fit of varying models of moncentric decay to see which fits the data most sensibly, and against which urban employment subcentres should be evaluates. 

We fine tune the choice of these two parameters in the model for London: the first to input the distance from which total employment and density are calculated; and second the functional form of the density decay. Various models and subcentre patterns are identified. The choice of model from which we continue is that where the identified CBD from the employment data and WZ geographic boundaries aligns with the broad delineation of the CAZ of central London. With this as our basis starting point, urban employment subcentres are those peripheral areas which have locally dense employment peaks in line with the central zone of the city.


```{r Estimated Gradient Functions, echo=F, fig.asp = 0.8, fig.width = 7, out.width = "100%"}
WZ.db$dist.CBD2 <- WZ.db$dist.CBD*WZ.db$dist.CBD
WZ.db$dist.CBD3 <- WZ.db$dist.CBD2*WZ.db$dist.CBD
M1 <- lm(log(ifelse(WZ.db$density > 0, WZ.db$density, 0.5)) ~ WZ.db$dist.CBD)
M2 <- lm(log(ifelse(WZ.db$density > 0, WZ.db$density, 0.5)) ~ WZ.db$dist.CBD + WZ.db$dist.CBD2)
M3 <- lm(log(ifelse(WZ.db$density > 0, WZ.db$density, 0.5)) ~ WZ.db$dist.CBD + WZ.db$dist.CBD2 + WZ.db$dist.CBD3)
M4 <- lm(log(ifelse(WZ.db$density > 0, WZ.db$density, 0.5)) ~ log(ifelse(WZ.db$dist.CBD > 0, WZ.db$dist.CBD, 0.5)))
WZ.db$dist.CBD2 <- NULL
WZ.db$dist.CBD3 <- NULL

t <- rbind(as.data.frame(cbind(Model="Linear", 
    x=seq(0.01, 200, by = 0.01), 
    y=exp(as.numeric(summary(M1)$coefficients[1,1]))*exp(as.numeric(summary(M1)$coefficients[2,1])*seq(0.01, 200, by = 0.01)), 
    Rsq=summary(M1)$adj.r.squared)),
  as.data.frame(cbind(Model="Squared", 
    x=seq(0.01, 200, by = 0.01), 
    y=exp(as.numeric(summary(M2)$coefficients[1,1]))*exp(as.numeric(summary(M2)$coefficients[2,1])*seq(0.01, 200, by = 0.01) + as.numeric(summary(M2)$coefficients[3,1])*(seq(0.01, 200, by = 0.01)^2)),
    Rsq=summary(M2)$adj.r.squared)),
  as.data.frame(cbind(Model="Cubed", 
    x=seq(0.01, 200, by = 0.01), 
    y=exp(as.numeric(summary(M3)$coefficients[1,1]))*exp(as.numeric(summary(M3)$coefficients[2,1])*seq(0.01, 200, by = 0.01) + as.numeric(summary(M3)$coefficients[3,1])*(seq(0.01, 200, by = 0.01)^2) + as.numeric(summary(M3)$coefficients[4,1])*(seq(0.01, 200, by = 0.01)^3)), 
    Rsq=summary(M3)$adj.r.squared)),
  as.data.frame(cbind(Model="Log", 
    x=seq(0.01, 200, by = 0.01), 
    y=exp(as.numeric(summary(M4)$coefficients[1,1]) + as.numeric(summary(M4)$coefficients[2,1])*log(seq(0.01, 200, by = 0.01))), 
    Rsq=summary(M4)$adj.r.squared)))
t$x <- as.numeric(as.character(t$x))
t$y <- as.numeric(as.character(t$y))
t$Rsq <- as.numeric(as.character(t$Rsq))
t$Model <- as.factor(t$Model)
rm(M1, M2, M3, M4)

ggplot(data=t, aes(x=x)) +
  geom_point(data=data.table(WZ.db)[,c("density", "dist.CBD")], mapping=aes(x=dist.CBD, y=density), alpha=0.2) +
  geom_line(aes(y = y, group = Model, color = Model)) +
  scale_color_manual(values = c("#ebdc87", "#ffa36c", "#d54062", "#799351")) +
  scale_y_continuous(limits = c(0, 2000), expand = c(0,0)) +
  scale_x_continuous(limits = c(0, 50), expand = c(0,0)) +
  labs(y = "Density per ha.", x = "Distance to City Centre (km)", fill = "Functional",
    title = "Estimated Employment Density Gradients", subtitle = paste0("London, England: (N = ", as.character(dim(WZ.db)[1]), ")"),
    caption = paste0("R-Squared: Linear=", unique(signif(t[t$Model=="Linear",]$Rsq, 4)),
    " ; Squared=", unique(signif(t[t$Model=="Squared",]$Rsq, 4)),
    " ; Cubed=", unique(signif(t[t$Model=="Cubed",]$Rsq, 4)),
    " ; Log=", unique(signif(t[t$Model=="Log",]$Rsq, 4)))) +
  theme_classic() +
  theme(legend.position="bottom", plot.caption = element_text(face = "italic"), 
        legend.title = element_blank(), panel.background=element_rect(fill="#E5E5E3"))
rm(t)
```



The choice of parameters for London are drawn to match the CAZ area. We want to pick up this extent as our CBD and see how peripherial subcentres emerge which have similar local density and employment peaks as London's central area. 

We choose our baseline density and total employment level following a series of parameter estimation and subcentre identification. The main choices are on the value of density and employment we choose as the baseline from which threshold cutoff values are determined. Too high a baseline density or employment, too few peripherial subcentres will be identified, too low a density or employment....

We choose parameter values of D= and E= to correspond to the distance from the central area from which we will draw the baseline values of CBD employment or density. As we increase the parameter values for E, we are capturing more total employment and thus increasing the radius will increase E. The converse is true for B. As we increase the radius from which we calculate the baseline density, then we will be including more non-central WZs and the average density value will be brought down marginally. 

We need to scale these parameters appropriately for the London context.


```{r Subcentre Identification for London, include=F}
source(gsub("Business & Employment", "Employment Subcentres/Code/Subcentre_Identification.R", wd))

# london.subcentres <- subcentre.identification(GEOGRAPHIES=WZ.db, VARS=c("WZ_CD", "employment", "area_ha"), GRADIENT="Cubed", CBD.cutD=30, CBD.cutE=0.2)
# saveRDS(london.subcentres, file=paste0(wd.data, "/London_Subcentres.rds"))

london.subcentres <- readRDS(paste0(wd.data, "/London_Subcentres.rds"))
CBD <- london.subcentres[["CBD_Base"]]
Gradient <- london.subcentres[["Gradient"]]
Subcentres <- london.subcentres[["Geographies"]]
SC_Stats <- london.subcentres[["Statistics"]]
rm(london.subcentres)
```




### 3.3. London's Employment Subcentres

After fine tuning the algorithm parameters for the London context, we reveal a map of employment subcentres across the city. With the granularity of WZ boundaries in core employment areas, we are able to delineate geographically granular employment areas in the city. The extent of the core CBD in central London is also highlighted with additional areas of high employment out around the city peripheral.

```{r London Employment Subcentre Map, echo=F, fig.asp = 0.8, fig.width = 7, out.width = "100%"}
t <- unique(st_intersection(st_buffer(CAZ, 0), st_buffer(Subcentres, 0))$subcentreID)
Subcentres$SC_Type <- as.character(Subcentres$SC_Type)
Subcentres$SC_Type[Subcentres$subcentreID %in% t[!is.na(t)]] <- "CAZ Subcentre"; rm(t)
Subcentres$SC_Type[is.na(Subcentres$SC_Type)] <- "Non-Subcentre"
Subcentres$SC_Type <- factor(Subcentres$SC_Type, levels=c("CAZ Subcentre", "Subcentre", "Candidate", "Non-Subcentre"))

ggplot() +
  geom_sf(data = Subcentres, aes(fill = SC_Type), lwd = 0, show.legend = FALSE) +
  scale_fill_manual(values=c("#FF6961", "#FF8D7B", "#FFF8AA", "#E5E5E3"), na.translate=FALSE) +
  labs(title = "", subtitle = "London Employment Subcentres", x = "", y = "") +
  scale_x_continuous(expand = c(0,0)) +
  coord_sf() +
  guides(shape = guide_legend(override.aes = list(size = 1)), fill = guide_legend(override.aes = list(size = 1)),
    color = guide_legend(override.aes = list(size = 1))) +
  theme_classic() +
  theme(axis.text.x=element_blank(), axis.ticks.x=element_blank(), axis.text.y=element_blank(), axis.ticks.y=element_blank(), 
    legend.position="bottom", legend.title = element_blank(), panel.background=element_rect(fill="#FFFFFF"))
```
  
  
  
```{r London Employment Subcentre Map - CAZ, echo=F, fig.asp = 0.8, fig.width = 7, out.width = "100%"}
ggplot() +
  geom_sf(data = Subcentres, aes(fill = SC_Type), lwd = 0, show.legend = FALSE) +
  geom_sf(data = CAZ, colour="black", alpha=0, lwd=0.5, show.legend = FALSE) +
  scale_fill_manual(values=c("#FF6961", "#FF8D7B", "#FFF8AA", "#E5E5E3"), na.translate=FALSE) +
  labs(title = "", subtitle = "London CAZ Employment Subcentres", x = "", y = "") +
  scale_x_continuous(expand = c(0,0)) +
  coord_sf(crs=27700, xlim=c(st_bbox(CAZ)[["xmin"]]*(1-.01), st_bbox(CAZ)[["xmax"]]*(1+.01)), 
    ylim=c(st_bbox(CAZ)[["ymin"]]*(1-.01), st_bbox(CAZ)[["ymax"]]*(1+.01))) +
  guides(shape = guide_legend(override.aes = list(size = 1)), fill = guide_legend(override.aes = list(size = 1)),
    color = guide_legend(override.aes = list(size = 1))) +
  theme_classic() +
  theme(axis.text.x=element_blank(), axis.ticks.x=element_blank(), axis.text.y=element_blank(), axis.ticks.y=element_blank(), 
    legend.position="bottom", legend.title = element_blank(), panel.background=element_rect(fill="#FFFFFF"))
```

The economy of London very much linked to geography with well defined industries tending to be associated with well defined areas. 

```{r London Subcentres Descriptive Stats, echo=F}
knitr::kable(SC_Stats[SC_Stats$subcentreID %in% Subcentres[Subcentres$SC_Type=="CAZ Subcentre",]$subcentreID,], 
  digits = 2, col.names = c("", "Employment", "Area (ha.)", "Avg. Dist to CBD (km)", "Avg. Density", "Tract Size (WZ Count)"), align=c("lccccc"))

knitr::kable(summary(SC_Stats[SC_Stats$subcentreID %in% Subcentres[Subcentres$SC_Type=="CAZ Subcentre",]$subcentreID,][,-c(1)]), digits = 2)

knitr::kable(summary(SC_Stats[SC_Stats$subcentreID %in% Subcentres[Subcentres$SC_Type=="Subcentre",]$subcentreID,][,-c(1)]), digits = 2)
```


## 4. Decomposing London Subcentres By Industry Typologies

We decompose employment areas in the greater municipal area according to the industry sectors of prominence located within, considering both employment and business composition. Detailed sectoral employment levels over space are limited to Census 2011 WZ aggregates of broad SIC industry sector. More detailed SIC divisions can be extracted using the open business registries to provide another indication of the types of industry sectors located over space. Additionally, relative proportions and distributions across the London WZ Classification geodemographic are used to identify any potential differences in employment areas and hotspots of the city. 

The distribution of SIC industry typologies for employment subcentres are plotted and compared. In particular, we are interested in differences which exist between these industry variables for WZ which form part of employment subcentres, and in particular the core CAZ employment centre, and those which are not part of an employment area.

```{r Combine WZ and Subcentre Data, include=F}
WZ.db <- merge(WZ.db, as.data.frame(Subcentres)[,c("tractID", "SC_Type", "subcentreID")], all.x=T, sort=F, by.x="WZ_CD", by.y="tractID")
```

This analysis has a few main advantages. While detailed employment data is relatively scarce, information on registered businesses is much more common and available for many time scales (see CDRC business census datasets). While the direct modelling of employment levels themselves is too detailed to be supported by just registered businesses, we are able to link the clusters of location of employment centres to these businesses if we can identify the underlying signature of what types, and quantities, of different industries in a given area are most commonly attributed to our employment subcentre hotspots.

Thus, the signature of the SIC-codes present in an employment center can be used as a justification of the region being a center. A similar signature if detected in a region, can make the region a contender for an employment center. This approach is beneficial as we are basing the analysis on business census data which is more readily available than the employement data.


```{r SIC Section-Division Lookup, include=F}
t <- data.table(rbind(cbind(c("Agriculture, forestry & fishing"), c("Section A"), c("BIG_1")),
  cbind(c("Mining, quarrying & utilities"), c("Section B", "Section D", "Section E"), c("BIG_2")),
  cbind(c("Manufacturing"), c("Section C"), c("BIG_3")),
  cbind(c("Construction"), c("Section F"), c("BIG_4")),
  cbind(c("Motor trades"), c("SIC_45"), c("BIG_5")),
  cbind(c("Wholesale"), c("SIC_46"), c("BIG_6")),
  cbind(c("Retail"), c("SIC_47"), c("BIG_7")),
  cbind(c("Transport & storage (inc postal)"), c("Section H"), c("BIG_8")),
  cbind(c("Accommodation & food services"), c("Section I"), c("BIG_9")),
  cbind(c("Information & communication"), c("Section J"), c("BIG_10")),
  cbind(c("Finance & insurance"), c("Section K"), c("BIG_11")),
  cbind(c("Property"), c("Section L"), c("BIG_12")),
  cbind(c("Professional, scientific & technical"), c("Section M"), c("BIG_13")),
  cbind(c("Business administration and support services"), c("Section N"), c("BIG_14")),
  cbind(c("Public administration & defence"), c("Section O"), c("BIG_15")),
  cbind(c("Education"), c("Section P"), c("BIG_16")),
  cbind(c("Health"), c("Section Q"), c("BIG_17")),
  cbind(c("Arts, entertainment, recreation and other services"), c("Section R", "Section S", "Section T", "Section U"), c("BIG_18"))))
names(t) <- c("BIG_NM", "Section", "BIG_CD")

SIC.lookup <- data.table(rbind(cbind(paste0("SIC_0", 1:4), rep("Section A", length(paste0("SIC_0", 1:4)))),
  cbind(paste0("SIC_0", 5:9), rep("Section B", length(paste0("SIC_0", 5:9)))),
  cbind(paste0("SIC_", 10:33), rep("Section C", length(paste0("SIC_", 10:33)))),
  cbind(paste0("SIC_", 35), rep("Section D", length(paste0("SIC_", 35)))),
  cbind(paste0("SIC_", 36:39), rep("Section E", length(paste0("SIC_", 36:39)))),
  cbind(paste0("SIC_", 41:43), rep("Section F", length(paste0("SIC_", 41:43)))),
  cbind(paste0("SIC_", 45:47), rep("Section G", length(paste0("SIC_", 45:47)))),
  cbind(paste0("SIC_", 49:53), rep("Section H", length(paste0("SIC_", 49:53)))),
  cbind(paste0("SIC_", 55:56), rep("Section I", length(paste0("SIC_", 55:56)))),
  cbind(paste0("SIC_", 58:63), rep("Section J", length(paste0("SIC_", 58:63)))),
  cbind(paste0("SIC_", 64:66), rep("Section K", length(paste0("SIC_", 64:66)))),
  cbind(paste0("SIC_", 68), rep("Section L", length(paste0("SIC_", 68)))),
  cbind(paste0("SIC_", 69:75), rep("Section M", length(paste0("SIC_", 69:75)))),
  cbind(paste0("SIC_", 77:82), rep("Section N", length(paste0("SIC_", 77:82)))),
  cbind(paste0("SIC_", 84), rep("Section O", length(paste0("SIC_", 84)))),
  cbind(paste0("SIC_", 85), rep("Section P", length(paste0("SIC_", 85)))),
  cbind(paste0("SIC_", 86:88), rep("Section Q", length(paste0("SIC_", 86:88)))),
  cbind(paste0("SIC_", 90:93), rep("Section R", length(paste0("SIC_", 90:93)))),
  cbind(paste0("SIC_", 94:96), rep("Section S", length(paste0("SIC_", 94:96)))),
  cbind(paste0("SIC_", 97:98), rep("Section T", length(paste0("SIC_", 97:98)))),
  cbind(paste0("SIC_", 99), rep("Section U", length(paste0("SIC_", 99))))))
names(SIC.lookup) <- c("SIC", "Section")

SIC.lookup <- merge(SIC.lookup, t, all.x=T, sort=F, by="Section")
SIC.lookup <- merge(SIC.lookup, t, all.x=T, sort=F, by.x="SIC", by.y="Section")
SIC.lookup$BIG_NM.x[is.na(SIC.lookup$BIG_NM.x)] <- SIC.lookup$BIG_NM.y[is.na(SIC.lookup$BIG_NM.x)]; SIC.lookup$BIG_NM.y <- NULL
SIC.lookup$BIG_CD.x[is.na(SIC.lookup$BIG_CD.x)] <- SIC.lookup$BIG_CD.y[is.na(SIC.lookup$BIG_CD.x)]; SIC.lookup$BIG_CD.y <- NULL
names(SIC.lookup)[names(SIC.lookup)=="BIG_NM.x"] <- "BIG_NM"
names(SIC.lookup)[names(SIC.lookup)=="BIG_CD.x"] <- "BIG_CD"

set.seed(57661109)
cols <- sample(c("#e6194B", "#3cb44b", "#ffe119", "#4363d8", "#f58231", "#911eb4", "#42d4f4", "#f032e6", "#bfef45", "#fabed4", "#469990", "#dcbeff", "#9A6324", "#fffac8", "#800000", "#aaffc3", "#808000", "#ffd8b1", "#000075", "#a9a9a9"))[1:length(unique(SIC.lookup$BIG_CD))]
SIC.lookup <- merge(SIC.lookup, data.frame(cbind(unique(SIC.lookup$BIG_CD), cols)),
  all.x=T, sort=F, by.x="BIG_CD", by.y="V1")
names(SIC.lookup) <- c("BIG_CD", "SIC", "Section", "BIG_NM", "colour"); rm(cols, t)

palette <- unique(SIC.lookup[,c("BIG_CD", "BIG_NM", "colour")])

t <- data.frame(do.call(rbind, lapply(split(SIC.lookup, SIC.lookup$BIG_CD), function(x) paste0(unique(x$Section), collapse="; "))))
t$BIG_CD <- rownames(t)
names(t) <- c("Sections", "BIG_CD")
t$Sections <- as.character(t$Sections)
t$BIG_CD <- as.character(t$BIG_CD)

t$Sections[t$BIG_CD=="BIG_5"] <- "SIC_45"
t$Sections[t$BIG_CD=="BIG_6"] <- "SIC_46"
t$Sections[t$BIG_CD=="BIG_7"] <- "SIC_47"

palette <- merge(palette, t, all.x=T, sort=F); rm(t)
palette$Sections[palette$Sections=="Section B; Section D; Section E"] <- "Section B; D; E"
palette$Sections[palette$Sections=="Section R; Section S; Section T; Section U"] <- "Section R; S; T; U"
palette$Bar <- 5
palette$colour <- as.character(palette$colour)
palette$BIG_CD <- factor(palette$BIG_CD, levels=rev(paste0("BIG_", 1:18)))
palette$label <- paste0(as.character(palette$BIG_NM), " (", as.character(palette$Sections), ")  (", as.character(palette$colour), ")")
```

```{r SIC Colour Guide, echo=F}
ggplot(palette, aes(x=BIG_CD, y=Bar, fill=BIG_NM), colour="#E5E5E3") +
  geom_bar(stat = "identity", fill = rev(palette$colour), alpha=0.6) +
  geom_text(data=palette, mapping=aes(x=BIG_CD, y=0, label=label), fontface="italic", colour="black", hjust=0, alpha=0.8) +
  labs(title = "SIC Broad Industry Group", subtitle = "Colour matching guide", x = "", y = "") +
  scale_x_discrete(expand = c(0,0)) +
  scale_y_continuous(expand = c(0,0)) +
  coord_flip() +
  guides(shape = guide_legend(override.aes = list(size = 1)), fill = guide_legend(override.aes = list(size = 1)),
    color = guide_legend(override.aes = list(size = 1))) +
  theme_classic() +
  theme(axis.text.x=element_blank(), axis.ticks.x=element_blank(),
    legend.position = "none", legend.title = element_blank(), panel.background=element_rect(fill="#E5E5E3"))
```

```{r SIC Sector Based Proportions, echo=F, fig.asp = 0.8, fig.width = 7, out.width = "100%"}
distribution.2013 <- merge(WZ.db[,c("WZ_CD", "subcentreID", "SC_Type")], BC.data[[1]], all.x=T, sort=F, by.x="WZ_CD", by.y="wz11")
distribution.2013 <- melt(data.table(distribution.2013)[,-c("geometry", "Year", "WZ_CD", "subcentreID", "Total")][,lapply(.SD, sum, na.rm=T), by=SC_Type], id.vars="SC_Type")
distribution.2013 <- dcast(distribution.2013, variable ~ SC_Type)
names(distribution.2013) <- c("SIC", "CAZ", "SC", "Cand", "NonSC")
distribution.2013$Total <- distribution.2013$NonSC + distribution.2013$Cand + distribution.2013$SC + distribution.2013$CAZ
distribution.2013 <- merge(distribution.2013, SIC.lookup[,c("BIG_CD", "SIC")], all.x=T, sort=F, by="SIC")
distribution.2013 <- distribution.2013[,-c("SIC", "Cand")][,lapply(.SD, sum, na.rm=T), by=BIG_CD]

distribution.2019 <- merge(WZ.db[,c("WZ_CD", "subcentreID", "SC_Type")], BC.data[[7]], all.x=T, sort=F, by.x="WZ_CD", by.y="wz11")
distribution.2019 <- melt(data.table(distribution.2019)[,-c("geometry", "Year", "WZ_CD", "subcentreID", "Total")][,lapply(.SD, sum, na.rm=T), by=SC_Type], id.vars="SC_Type")
distribution.2019 <- dcast(distribution.2019, variable ~ SC_Type)
names(distribution.2019) <- c("SIC", "CAZ", "SC", "Cand", "NonSC")
distribution.2019$Total <- distribution.2019$NonSC + distribution.2019$Cand + distribution.2019$SC + distribution.2019$CAZ
distribution.2019 <- merge(distribution.2019, SIC.lookup[,c("BIG_CD", "SIC")], all.x=T, sort=F, by="SIC")
distribution.2019 <- distribution.2019[,-c("SIC", "Cand")][,lapply(.SD, sum, na.rm=T), by=BIG_CD]

distribution.empl <- data.table(WZ.db)[,c("SC_Type", "Empl_SIC_A", "Empl_SIC_B", "Empl_SIC_C", "Empl_SIC_D", "Empl_SIC_E", "Empl_SIC_F", "Empl_SIC_G", "Empl_SIC_H", "Empl_SIC_I", "Empl_SIC_J", "Empl_SIC_K", "Empl_SIC_L", "Empl_SIC_M", "Empl_SIC_N", "Empl_SIC_O", "Empl_SIC_P", "Empl_SIC_Q", "Empl_SIC_RS", "Empl_SIC_T", "Empl_SIC_U")]
names(distribution.empl) <- gsub("Empl_", "", names(distribution.empl))
names(distribution.empl) <- gsub("SIC_", "Section ", names(distribution.empl))
distribution.empl <- melt(data.table(distribution.empl)[,lapply(.SD, sum, na.rm=T), by=SC_Type], id.vars="SC_Type")
distribution.empl <- dcast(distribution.empl, variable ~ SC_Type)
names(distribution.empl) <- c("SIC", "CAZ", "SC", "Cand", "NonSC")
distribution.empl$Total <- distribution.empl$NonSC + distribution.empl$Cand + distribution.empl$SC + distribution.empl$CAZ
distribution.empl$SIC <- as.character(distribution.empl$SIC)
distribution.empl[distribution.empl=="Section RS"] <- "Section R"
distribution.empl <- merge(distribution.empl, SIC.lookup[,c("BIG_CD", "Section")], all.x=T, sort=F, by.x="SIC", by.y="Section")
distribution.empl <- distribution.empl[,-c("SIC", "Cand")][,lapply(.SD, sum, na.rm=T), by=BIG_CD]

colour <- merge(data.frame(BIG_CD=as.character(distribution.2013$BIG_CD)[order(distribution.2013$Total)]), unique(SIC.lookup[,c("BIG_CD", "colour")]), all.x=T, sort=F)

t1 <- melt(distribution.empl, id.vars="BIG_CD")
t1$Type <- "Employment 2011"
t2 <- melt(distribution.2013, id.vars="BIG_CD")
t2$Type <- "Business 2013"
t3 <- melt(distribution.2019, id.vars="BIG_CD")
t3$Type <- "Business 2019"
t <- rbind(t1, t2)
t <- rbind(t, t3); rm(t1, t2, t3)

t$BIG_CD <- factor(as.character(t$BIG_CD), levels=as.character(distribution.2013$BIG_CD)[order(distribution.2013$Total)])
t$Type <- factor(t$Type, levels=c("Employment 2011", "Business 2013", "Business 2019"))
levels(t$variable)[levels(t$variable)=="CAZ"] <- "CAZ Subcentres"
levels(t$variable)[levels(t$variable)=="SC"] <- "Non CAZ Subcentres"
levels(t$variable)[levels(t$variable)=="NonSC"] <- "Non Subcentres"

ggplot(t, aes(x=Type, y=value, fill=BIG_CD)) +
  geom_bar(stat="identity", position="fill", width=0.4) +
  labs(title = "Sector Decompositions", subtitle = "SIC Broad Industry Group Distributions", x = "", y = "Proportions",
    caption="Using most comparable years with small area breakdowns of employment") +
  scale_fill_manual(values=as.character(colour$colour)) +
  scale_x_discrete(expand = c(0.5,0.5)) +
  scale_y_continuous(expand = c(0,0)) +
  theme_classic() +
  theme(axis.ticks.x=element_blank(), legend.title = element_blank(), plot.caption = element_text(face = "italic"), 
    axis.text.x = element_text(angle = 45, hjust = 1), panel.background=element_rect(fill="#E5E5E3")) +
  guides(fill = guide_legend(reverse = TRUE)) +
  facet_wrap(~ variable, nrow = 1)
```


```{r Counts and Broad SIC Breakdowns - Business Census 2013, echo=F, fig.asp = 0.8, fig.width = 7, out.width = "100%"}
t <- as_tibble(melt(merge(distribution.2013, unique(SIC.lookup[,c("BIG_CD", "colour")]), all.x=T, sort=F), id.vars = c("BIG_CD", "colour"))) %>%
    mutate(BIG_CD_fct = BIG_CD, variable = as.factor(variable), BIG_CD = reorder_within(BIG_CD, value, variable))
levels(t$variable)[levels(t$variable)=="CAZ"] <- "CAZ Subcentres"
levels(t$variable)[levels(t$variable)=="SC"] <- "Non CAZ Subcentres"
levels(t$variable)[levels(t$variable)=="NonSC"] <- "Non Subcentres"

ggplot(data=t, aes(BIG_CD, value, fill = BIG_CD_fct)) +
  geom_bar(stat="identity", width=0.6, show.legend = FALSE) +
  facet_wrap(~variable, scales = "free") +
  labs(title = "Business Census Count 2013", subtitle = "Decomposition by Broad SIC Group", y="Counts") +
  scale_fill_manual(values=as.character(merge(data.frame(BIG_CD=levels(t$BIG_CD_fct)), unique(SIC.lookup[,c("BIG_CD", "colour")]), all.x=T, sort=F)$colour)) +
  coord_flip() +
  scale_x_reordered() +
  scale_y_continuous(expand = c(0,0)) +
  theme_classic() +
  theme(axis.ticks.x=element_blank(), legend.title = element_blank(), plot.caption = element_text(face = "italic"), 
    axis.title.y=element_blank(), axis.text.x = element_text(angle = 45, hjust = 1), panel.background=element_rect(fill="#E5E5E3"))
```


```{r Counts and Broad SIC Breakdowns - Business Census 2019, echo=F, fig.asp = 0.8, fig.width = 7, out.width = "100%"}
t <- as_tibble(melt(merge(distribution.2019, unique(SIC.lookup[,c("BIG_CD", "colour")]), all.x=T, sort=F), id.vars = c("BIG_CD", "colour"))) %>%
    mutate(BIG_CD_fct = BIG_CD, variable = as.factor(variable), BIG_CD = reorder_within(BIG_CD, value, variable))
levels(t$variable)[levels(t$variable)=="CAZ"] <- "CAZ Subcentres"
levels(t$variable)[levels(t$variable)=="SC"] <- "Non CAZ Subcentres"
levels(t$variable)[levels(t$variable)=="NonSC"] <- "Non Subcentres"

ggplot(data=t, aes(BIG_CD, value, fill = BIG_CD_fct)) +
  geom_bar(stat="identity", width=0.6, show.legend = FALSE) +
  facet_wrap(~variable, scales = "free") +
  labs(title = "Business Census Count 2019", subtitle = "Decomposition by Broad SIC Group", y="Counts") +
  scale_fill_manual(values=as.character(merge(data.frame(BIG_CD=levels(t$BIG_CD_fct)), unique(SIC.lookup[,c("BIG_CD", "colour")]), all.x=T, sort=F)$colour)) +
  coord_flip() +
  scale_x_reordered() +
  scale_y_continuous(expand = c(0,0)) +
  theme_classic() +
  theme(axis.ticks.x=element_blank(), legend.title = element_blank(), plot.caption = element_text(face = "italic"), 
    axis.title.y=element_blank(), axis.text.x = element_text(angle = 45, hjust = 1), panel.background=element_rect(fill="#E5E5E3"))
```


```{r Counts and Broad SIC Breakdowns - Employment 2011, echo=F, fig.asp = 0.8, fig.width = 7, out.width = "100%"}
t <- as_tibble(melt(merge(distribution.empl, unique(SIC.lookup[,c("BIG_CD", "colour")]), all.x=T, sort=F), id.vars = c("BIG_CD", "colour"))) %>%
    mutate(BIG_CD_fct = BIG_CD, variable = as.factor(variable), BIG_CD = reorder_within(BIG_CD, value, variable))
levels(t$variable)[levels(t$variable)=="CAZ"] <- "CAZ Subcentres"
levels(t$variable)[levels(t$variable)=="SC"] <- "Non CAZ Subcentres"
levels(t$variable)[levels(t$variable)=="NonSC"] <- "Non Subcentres"

ggplot(data=t, aes(BIG_CD, value, fill = BIG_CD_fct)) +
  geom_bar(stat="identity", width=0.6, show.legend = FALSE) +
  facet_wrap(~variable, scales = "free") +
  labs(title = "Employment Count 2011", subtitle = "Decomposition by Broad SIC Group", y="Counts") +
  scale_fill_manual(values=as.character(merge(data.frame(BIG_CD=levels(t$BIG_CD_fct)), unique(SIC.lookup[,c("BIG_CD", "colour")]), all.x=T, sort=F)$colour)) +
  coord_flip() +
  scale_x_reordered() +
  scale_y_continuous(expand = c(0,0)) +
  theme_classic() +
  theme(axis.ticks.x=element_blank(), legend.title = element_blank(), plot.caption = element_text(face = "italic"), 
    axis.title.y=element_blank(), axis.text.x = element_text(angle = 45, hjust = 1), panel.background=element_rect(fill="#E5E5E3"))
```


```{r Yearly Growth of Top Sectors, echo=F, fig.asp = 0.8, fig.width = 7, out.width = "100%"}
yearly <- list()
for(i in 1:length(BC.data)){
  distribution <- merge(WZ.db[,c("WZ_CD", "subcentreID", "SC_Type")], BC.data[[i]], all.x=T, sort=F, by.x="WZ_CD", by.y="wz11")
  distribution <- melt(data.table(distribution)[,-c("geometry", "Year", "WZ_CD", "subcentreID", "Total")][,lapply(.SD, sum, na.rm=T), by=SC_Type], id.vars="SC_Type")
  distribution <- dcast(distribution, variable ~ SC_Type)
  names(distribution) <- c("SIC", "CAZ", "SC", "Cand", "NonSC")
  distribution$Total <- distribution$NonSC + distribution$Cand + distribution$SC + distribution$CAZ
  distribution <- merge(distribution, SIC.lookup[,c("BIG_CD", "SIC")], all.x=T, sort=F, by="SIC")
  distribution <- distribution[,-c("SIC", "Cand")][,lapply(.SD, sum, na.rm=T), by=BIG_CD]
  distribution$Year <- BC.data[[i]]$Year[1]
  yearly[[i]] <- distribution
}
yearly <- data.frame(do.call(rbind, yearly))
yearly$Year <- as.numeric(yearly$Year)
yearly <- melt(yearly[yearly$BIG_CD %in% c("BIG_13", "BIG_14", "BIG_10", "BIG_18"),], id.vars=c("BIG_CD", "Year"))
levels(yearly$variable)[levels(yearly$variable)=="CAZ"] <- "CAZ Subcentres"
levels(yearly$variable)[levels(yearly$variable)=="SC"] <- "Non CAZ Subcentres"
levels(yearly$variable)[levels(yearly$variable)=="NonSC"] <- "Non Subcentres"

ggplot(data=yearly, aes(Year, value, colour = BIG_CD)) +
  geom_line(lwd=1) +
  geom_point() +
  facet_wrap(~variable, scales = "free_y", nrow=4) +
  labs(title = "Yearly Growth of Top Sectors", subtitle = "Registered Business by Broad SIC Group", y="Counts") +
  scale_colour_manual(values=as.character(unique(SIC.lookup[SIC.lookup$BIG_CD %in% c("BIG_10", "BIG_13", "BIG_14", "BIG_18"), c("BIG_CD", "colour")])$colour)) +
  scale_y_continuous(expand = c(0,0)) +
  scale_x_continuous(expand = c(0,0)) +
  theme_classic() +
  theme(axis.ticks.x=element_blank(), legend.title = element_blank(), plot.caption = element_text(face = "italic"), 
    axis.title.x=element_blank(), axis.text.x = element_text(angle = 45, hjust = 1), panel.background=element_rect(fill="#E5E5E3"))
```


```{r LWZC Breakdown, echo=F, fig.asp = 0.8, fig.width = 7, out.width = "100%"}
t <- as_tibble(WZ.db[,c("WZ_CD", "SubGroup", "SC_Type")]) %>%
  select(-c("WZ_CD", "geometry")) %>%
  group_by(SC_Type, SubGroup) %>%
  count(name="value") %>%
  dplyr::rename(variable=SC_Type) %>%
  mutate(SubGroup = as.factor(SubGroup)) %>%
  mutate(SubGroup_fct = SubGroup, variable = as.factor(variable), SubGroup = reorder_within(SubGroup, value, variable))
    
ggplot(data=t, aes(SubGroup, value, fill = SubGroup_fct)) +
  geom_bar(stat="identity", width=0.6, show.legend = FALSE) +
  facet_wrap(~variable, scales = "free") +
  labs(title = "London Workplace Zone Classification", subtitle = "Decomposition Across (Non)Subcentres", y="Counts") +
  coord_flip() +
  scale_x_reordered() +
  scale_y_continuous(expand = c(0,0)) +
  theme_classic() +
  theme(axis.ticks.x=element_blank(), legend.title = element_blank(), plot.caption = element_text(face = "italic"), 
    axis.title.y=element_blank(), axis.text.x = element_text(angle = 45, hjust = 1), panel.background=element_rect(fill="#E5E5E3"))
```
